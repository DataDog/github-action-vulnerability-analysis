#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

build_file="$1"

echo "- Compute dependency graph for $build_file"
# Possible exit statuses for 'snyk test':
# - 0: success, no vulns found
# - 1: action_needed, vulns found
# - 2: failure, try to re-run command
# - 3: failure, no supported projects detected
snyk test --print-deps --json --file="$build_file" > deps.json || export exit_code=$?
echo "Snyk test command returned exit code '$exit_code'"

# TODO invert this logic so if they add more exit codes we handle them right
if [[ "$exit_code" -eq 2 ]] || [[ "$exit_code" -eq 3 ]]; then
  echo "Error when computing dependency graph for file $build_file"
  exit 1
fi
